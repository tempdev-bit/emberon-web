<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Emberon PNG Encoder/Decoder</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
<style>
  body { font-family: sans-serif; padding: 2rem; background: #1e1e1e; color: #eee; }
  input, button, select { margin-top: 0.5rem; display: block; }
  #output { margin-top: 1rem; white-space: pre-wrap; }
</style>
</head>
<body>
<h1>Emberon PNG Encoder/Decoder</h1>

<label>Choose file to encode/decode:</label>
<input type="file" id="fileInput">

<label>Operation:</label>
<select id="operation">
  <option value="encode">Encode → PNG</option>
  <option value="decode">Decode PNG → File</option>
</select>

<button id="runBtn">Run</button>

<div id="output"></div>

<!-- Embed Python code directly -->
<script type="text/python" id="emberon-py">
import sys
from PIL import Image
import lzma  # Will be installed dynamically

def encode_file_to_png(input_path, output_path, scale=2, quality=6):
    with open(input_path, "rb") as f:
        data = f.read()
    compressed = lzma.compress(data)
    size = (len(compressed)**0.5).__ceil__()
    img = Image.new("L", (size, size))
    img.putdata(list(compressed) + [0]*(size*size - len(compressed)))
    img.save(output_path, "PNG", compress_level=quality)

def decode_png_to_file(input_path, output_path):
    img = Image.open(input_path).convert("L")
    data = bytes(img.getdata()).rstrip(b'\x00')
    with open(output_path, "wb") as f:
        f.write(lzma.decompress(data))
</script>

<script type="text/javascript">
let pyodideReady = false;
let pyodide;

async function initPyodide() {
  pyodide = await loadPyodide();
  await pyodide.loadPackage(["micropip"]);
  // Install packages not in standard Pyodide
  await pyodide.runPythonAsync(`
import micropip
await micropip.install("Pillow")
await micropip.install("lzma")  # Required for your code
  `);

  // Write embedded Python code to FS
  const pyCode = document.getElementById("emberon-py").textContent;
  pyodide.FS.writeFile("emberon.py", pyCode);

  pyodideReady = true;
  console.log("Pyodide ready!");
}

initPyodide();

document.getElementById("runBtn").addEventListener("click", async () => {
  if (!pyodideReady) return alert("Python not ready yet!");

  const fileInput = document.getElementById("fileInput");
  if (!fileInput.files.length) return alert("Please select a file!");
  const file = fileInput.files[0];
  const buffer = await file.arrayBuffer();
  pyodide.FS.writeFile(file.name, new Uint8Array(buffer));

  const operation = document.getElementById("operation").value;
  let cmd = '';
  if (operation === 'encode') {
    cmd = `import emberon; emberon.encode_file_to_png("${file.name}", "${file.name}.png", 2, 6)`;
  } else {
    cmd = `import emberon; emberon.decode_png_to_file("${file.name}", "decoded_${file.name}")`;
  }

  try {
    await pyodide.runPythonAsync(cmd);
    document.getElementById("output").textContent = `${operation} finished!\nCheck Pyodide FS for output file.`;
  } catch (err) {
    document.getElementById("output").textContent = "Error: " + err;
  }
});
</script>
</body>
</html>

